<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidence úrazů - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="root">
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto mb-4"></div>
                <p class="text-gray-600">Načítám data z Google Sheets...</p>
            </div>
        </div>
    </div>

    <script>
var SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSuLoAIfMc889kp56PKQIEE6mmdQwako_Orxj1ZmSjbmChHfQilbKx82X3LzwYy9nci_G780ApKj1ZH/pub?output=csv';
var COLORS = { primary: '#8BC34A', secondary: '#FF9800', accent: '#2196F3', purple: '#9C27B0', red: '#F44336', cyan: '#00BCD4' };
var dayNamesShort = ['Ne', 'Po', 'Út', 'St', 'Čt', 'Pá', 'So'];

function parseCSV(text) {
    var lines = text.split('\n');
    var headers = lines[0].split(',').map(function(h) { return h.trim().replace(/"/g, ''); });
    var data = [];
    for (var i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        var values = [];
        var current = '';
        var inQuotes = false;
        for (var j = 0; j < lines[i].length; j++) {
            var c = lines[i][j];
            if (c === '"') inQuotes = !inQuotes;
            else if (c === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
            else current += c;
        }
        values.push(current.trim());
        var row = {};
        headers.forEach(function(h, idx) { row[h] = values[idx] || ''; });
        data.push(row);
    }
    return data;
}

function parseDate(s) {
    if (!s) return null;
    if (s.includes('.')) { var p = s.split('.'); return new Date(p[2], p[1]-1, p[0]); }
    return new Date(s);
}

function parseTime(s) {
    if (!s) return '08:00';
    var m = s.match(/(\d{1,2}):(\d{2})/);
    return m ? m[1].padStart(2,'0') + ':' + m[2] : '08:00';
}

fetch(SHEET_URL)
    .then(function(r) { return r.text(); })
    .then(function(text) {
        var raw = parseCSV(text);
        var incidents = raw.map(function(row, i) {
            return {
                id: i,
                date: row['Datum úrazu'] || '',
                time: parseTime(row['Čas úrazu']),
                location: row['Místo úrazu'] || 'Neuvedeno',
                cause: row['Příčina'] || 'Neuvedeno',
                source: row['Zdroj'] || 'Neuvedeno'
            };
        }).filter(function(r) { return r.date; });

        var years = Array.from(new Set(incidents.map(function(i) { 
            var d = parseDate(i.date); 
            return d ? d.getFullYear() : null; 
        }).filter(Boolean))).sort(function(a,b) { return b-a; });

        var locations = Array.from(new Set(incidents.map(function(i) { return i.location; }))).filter(function(l) { return l && l !== 'Neuvedeno'; }).sort();
        
        var sources = {};
        incidents.forEach(function(i) { sources[i.source] = (sources[i.source]||0) + 1; });
        var sourceData = Object.entries(sources).sort(function(a,b) { return b[1] - a[1]; }).slice(0,8);

        var causes = {};
        incidents.forEach(function(i) { causes[i.cause] = (causes[i.cause]||0) + 1; });
        var causeData = Object.entries(causes).sort(function(a,b) { return b[1] - a[1]; }).slice(0,8);

        var yearCounts = {};
        years.forEach(function(y) { yearCounts[y] = 0; });
        incidents.forEach(function(i) { var d = parseDate(i.date); if(d) yearCounts[d.getFullYear()]++; });

        var dayCounts = [0,0,0,0,0,0,0];
        incidents.forEach(function(i) { var d = parseDate(i.date); if(d) dayCounts[d.getDay()]++; });

        var hourCounts = {};
        for(var h=6; h<=18; h++) hourCounts[h] = 0;
        incidents.forEach(function(i) { 
            var hour = parseInt(i.time.split(':')[0]); 
            if(hour >= 6 && hour <= 18) hourCounts[hour]++; 
        });

        var locCounts = {};
        locations.forEach(function(l) { locCounts[l] = 0; });
        incidents.forEach(function(i) { if(locCounts[i.location] !== undefined) locCounts[i.location]++; });

        var thisYear = incidents.filter(function(i) { var d = parseDate(i.date); return d && d.getFullYear() === new Date().getFullYear(); }).length;
        var avgPerYear = years.length ? Math.round(incidents.length / years.length) : 0;

        document.getElementById('root').innerHTML = '\
        <header class="bg-white border-b border-gray-200 px-6 py-4 sticky top-0 z-50">\
            <div class="max-w-7xl mx-auto flex items-center justify-between flex-wrap gap-4">\
                <div class="flex items-center gap-4">\
                    <div class="bg-green-500 text-white px-4 py-2 rounded-md font-bold text-sm">alza.cz</div>\
                    <div>\
                        <h1 class="text-xl font-semibold text-gray-900">Evidence úrazů</h1>\
                        <p class="text-xs text-gray-500">Dashboard BOZP • ' + incidents.length + ' záznamů</p>\
                    </div>\
                </div>\
            </div>\
        </header>\
        <main class="p-6 max-w-7xl mx-auto">\
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">\
                <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200">\
                    <p class="text-gray-500 text-sm">Celkem úrazů</p>\
                    <p class="text-3xl font-bold text-gray-900 mt-1">' + incidents.length + '</p>\
                </div>\
                <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200">\
                    <p class="text-gray-500 text-sm">Tento rok (' + new Date().getFullYear() + ')</p>\
                    <p class="text-3xl font-bold text-gray-900 mt-1">' + thisYear + '</p>\
                </div>\
                <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200">\
                    <p class="text-gray-500 text-sm">Lokality</p>\
                    <p class="text-3xl font-bold text-gray-900 mt-1">' + locations.length + '</p>\
                </div>\
                <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200">\
                    <p class="text-gray-500 text-sm">Průměr/rok</p>\
                    <p class="text-3xl font-bold text-gray-900 mt-1">' + avgPerYear + '</p>\
                </div>\
            </div>\
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">\
                <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200">\
                    <h3 class="text-gray-900 font-semibold mb-4">Zdroje úrazů</h3>\
                    <canvas id="sourceChart" height="200"></canvas>\
                </div>\
                <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200">\
                    <h3 class="text-gray-900 font-semibold mb-4">Příčiny úrazů</h3>\
                    <canvas id="causeChart" height="200"></canvas>\
                </div>\
            </div>\
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">\
                <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200">\
                    <h3 class="text-gray-900 font-semibold mb-4">Vývoj podle roků</h3>\
                    <canvas id="yearChart" height="200"></canvas>\
                </div>\
                <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200">\
                    <h3 class="text-gray-900 font-semibold mb-4">Úrazy podle dne v týdnu</h3>\
                    <canvas id="dayChart" height="200"></canvas>\
                </div>\
            </div>\
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">\
                <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200">\
                    <h3 class="text-gray-900 font-semibold mb-4">Úrazy podle hodiny</h3>\
                    <canvas id="hourChart" height="200"></canvas>\
                </div>\
                <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200">\
                    <h3 class="text-gray-900 font-semibold mb-4">Podíl lokalit</h3>\
                    <canvas id="locChart" height="200"></canvas>\
                </div>\
            </div>\
        </main>\
        <footer class="border-t border-gray-200 py-4 text-center bg-white mt-6">\
            <p class="text-gray-400 text-xs">Evidence pracovních úrazů © 2025 • Systém BOZP</p>\
        </footer>';

        // Grafy
        new Chart(document.getElementById('sourceChart'), {
            type: 'bar',
            data: { labels: sourceData.map(function(d){return d[0];}), datasets: [{label: 'Počet', data: sourceData.map(function(d){return d[1];}), backgroundColor: COLORS.accent}] },
            options: { indexAxis: 'y', plugins: { legend: { display: false } } }
        });

        new Chart(document.getElementById('causeChart'), {
            type: 'bar',
            data: { labels: causeData.map(function(d){return d[0].length > 20 ? d[0].slice(0,18)+'...' : d[0];}), datasets: [{label: 'Počet', data: causeData.map(function(d){return d[1];}), backgroundColor: COLORS.secondary}] },
            options: { indexAxis: 'y', plugins: { legend: { display: false } } }
        });

        new Chart(document.getElementById('yearChart'), {
            type: 'bar',
            data: { labels: years.slice().reverse().map(String), datasets: [{label: 'Počet', data: years.slice().reverse().map(function(y){return yearCounts[y];}), backgroundColor: COLORS.primary}] },
            options: { plugins: { legend: { display: false } } }
        });

        new Chart(document.getElementById('dayChart'), {
            type: 'bar',
            data: { labels: dayNamesShort, datasets: [{label: 'Počet', data: dayCounts, backgroundColor: dayCounts.map(function(_,i){return i===0||i===6 ? COLORS.secondary : COLORS.primary;})}] },
            options: { plugins: { legend: { display: false } } }
        });

        new Chart(document.getElementById('hourChart'), {
            type: 'bar',
            data: { labels: Object.keys(hourCounts).map(function(h){return h+':00';}), datasets: [{label: 'Počet', data: Object.values(hourCounts), backgroundColor: COLORS.accent}] },
            options: { plugins: { legend: { display: false } } }
        });

        new Chart(document.getElementById('locChart'), {
            type: 'doughnut',
            data: { labels: locations, datasets: [{data: locations.map(function(l){return locCounts[l];}), backgroundColor: [COLORS.primary, COLORS.secondary, COLORS.accent, COLORS.purple, COLORS.red, COLORS.cyan]}] }
        });
    })
    .catch(function(e) {
        document.getElementById('root').innerHTML = '<div class="min-h-screen flex items-center justify-center"><div class="bg-white p-8 rounded-xl shadow text-center"><p class="text-red-500 text-xl mb-2">⚠️ Chyba</p><p class="text-gray-600">' + e.message + '</p></div></div>';
    });
    </script>
</body>
</html>
